<!DOCTYPE html>
<html>
<head>
    <title>RunningTracker MongoDB Visualization</title>
    <style>
        table { border-collapse: collapse; margin-bottom: 2em; }
        th, td { border: 1px solid #ccc; padding: 0.5em; }
        th { background: #eee; }
        #chart-container { width: 90vw; max-width: 900px; margin: 2em auto; }
        details { margin-top: 2em; }
        summary { font-size: 1.1em; cursor: pointer; font-weight: bold; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Pass grouped data to JS
        window.groupedData = {{ grouped|tojson }};
    </script>
    <script src="{{ url_for('static', filename='chart.js') }}"></script>
</head>
<body>
    <h1>Summary Data Grouped by Source File</h1>
    <div id="chart-container">
        <canvas id="lapChart"></canvas>
    </div>
    {% for source, laps in grouped.items() %}
        {% set total_distance = laps|map(attribute='LapDistance_m')|map('float')|sum %}
        {% set last_lap = laps[-1] if laps|length > 0 else {} %}
        {% set total_time = last_lap.get('LapTotalTime_formatted', '') %}
        {% set date_match = source | regex_search('([0-9]{4}-[0-9]{2}-[0-9]{2})') %}
        <h2>
            {% if date_match %}
                {{ date_match.group(1) }}
            {% else %}
                {{ source }}
            {% endif %}
        </h2>
        <table>
            <tr>
                <th>Total Distance</th>
                <th>Total Time</th>
            </tr>
            <tr>
                <td>{{ '%.2f' % total_distance }} m</td>
                <td>{{ total_time }}</td>
            </tr>
        </table>
        <details>
            <summary>Show Laps for
                {% if date_match %}
                    {{ date_match.group(1) }}
                {% else %}
                    {{ source }}
                {% endif %}
            </summary>
            <table>
                <tr>
                    <th>Lap</th>
                    <th>Lap Start</th>
                    <th>Lap Distance</th>
                    <th>Pace</th>
                    <th>Lap time</th>
                </tr>
                {% for row in laps %}
                <tr>
                    <td>{{ row.get("LapNumber", "") }}</td>
                    <td>{{ row.get("LapStartTime", "") }}</td>
                    <td>{{ row.get("LapDistance_m", "") }}</td>
                    <td>{{ row.get("Pace_min_per_km", "") }}</td>
                    <td>{{ row.get("LapTotalTime_formatted", "") }}</td>
                </tr>
                {% endfor %}
            </table>
        </details>
    {% endfor %}

    <!-- Collapsible detailed information -->
    <h2>Detailed Data</h2>
    {% for source, details in detailed.items() %}
        <details>
            {% set date_match = source | regex_search('([0-9]{4}-[0-9]{2}-[0-9]{2})') %}

            <summary>Detailed for {% if date_match %}
                {{ date_match.group(1) }}
            {% else %}
                {{ source }}
            {% endif %}

            </summary>
            <table>
                <tr>
                    {% for key in details[0].keys() %}
                        <th>{{ key }}</th>
                    {% endfor %}
                </tr>
                {% for row in details %}
                <tr>
                    {% for value in row.values() %}
                        <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </details>
    {% endfor %}
</body>
</html>