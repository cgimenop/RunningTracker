<!DOCTYPE html>
<html>
<head>
    <title>RunningTracker MongoDB Visualization</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        window.groupedData = {{ grouped|tojson }};
    </script>
    <script src="{{ url_for('static', filename='chart.js') }}"></script>
</head>
<body>
    {% macro lap_icon(lap, fastest, slowest) -%}
        {% if lap and fastest and lap['LapNumber'] == fastest['LapNumber'] %}
            <span title="Fastest Lap" style="font-size:1.2em;vertical-align:middle;">‚è±Ô∏è</span>
        {% elif lap and slowest and lap['LapNumber'] == slowest['LapNumber'] %}
            <span title="Slowest Lap" style="font-size:1.2em;vertical-align:middle;">üê¢</span>
        {% else %}
            <span style="display:inline-block;width:1.5em;"></span>
        {% endif %}
    {%- endmacro %}

    <h1>Run Train Summary</h1>
    <div id="chart-container">
        <canvas id="lapChart"></canvas>
    </div>

    <h2>Records</h2>
    <table>
        <tr>
            <th>Concept</th>
            <th>Value</th>
            <th>Date</th>
        </tr>
        <tr>
            <td>Fastest Lap</td>
            <td>
                {% if fastest_lap %}
                    {{ fastest_lap.LapTotalTime_formatted }}
                {% else %}-{% endif %}
            </td>
            <td>
                {% if fastest_lap %}
                    {% set date_match = fastest_lap._source_file | regex_search('([0-9]{4}-[0-9]{2}-[0-9]{2})') %}
                    {{ date_match.group(1) if date_match else fastest_lap._source_file }}
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr>
            <td>Slowest Lap</td>
            <td>
                {% if slowest_lap %}
                    {{ slowest_lap.LapTotalTime_formatted }}
                {% else %}-{% endif %}
            </td>
            <td>
                {% if slowest_lap %}
                    {% set date_match = slowest_lap._source_file | regex_search('([0-9]{4}-[0-9]{2}-[0-9]{2})') %}
                    {{ date_match.group(1) if date_match else slowest_lap._source_file }}
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr>
            <td>Longest Distance</td>
            <td>
                {% if longest_distance_file %}
                    {{ '%.2f' % longest_distance_file.total_distance }} m
                {% else %}-{% endif %}
            </td>
            <td>
                {% if longest_distance_file %}
                    {{ longest_distance_file.date }}
                {% else %}-{% endif %}
            </td>
        </tr>
        <tr>
            <td>Longest Time</td>
            <td>
                {% if longest_time_file %}
                    {{ longest_time_file.total_time_formatted }}
                {% else %}-{% endif %}
            </td>
            <td>
                {% if longest_time_file %}
                    {{ longest_time_file.date }}
                {% else %}-{% endif %}
            </td>
        </tr>
    </table>

    <h2>Summary Data</h2>
    {% for file in file_summaries %}
        {% set all_laps = file_all_laps[file.source] %}
        {% set laps = file_valid_laps[file.source] %}
        {% set fastest = laps | min(attribute='LapTotalTime_s') %}
        {% set slowest = laps | max(attribute='LapTotalTime_s') %}
        <h3>{{ file.date }}</h3>
        <table>
            <tr>
                <th></th>
                <th>Lap</th>
                <th>Lap Start</th>
                <th>Lap Distance</th>
                <th>Pace</th>
                <th>Lap time</th>
            </tr>
            {% for row in all_laps %}
            <tr>
                <td>{{ lap_icon(row, fastest, slowest) }}</td>
                <td>{{ row.get("LapNumber", "") }}</td>
                <td><span class="local-datetime">{{ row.get("LapStartTime", "") }}</span></td>
                <td>{{ row.get("LapDistance_m", "") }}</td>
                <td>
                    {% if row.get("Pace_min_per_km") is not none %}
                        {{ '%.2f' % row.get("Pace_min_per_km") }} min/km
                    {% else %}-{% endif %}
                </td>
                <td>{{ row.get("LapTotalTime_formatted", "") }}</td>
            </tr>
            {% endfor %}
        </table>
    {% endfor %}

    <h2>Detailed Data</h2>
    {% for source, details in detailed.items() %}
        {% set date_match = source | regex_search('([0-9]{4}-[0-9]{2}-[0-9]{2})') %}
        <details>
            <summary>Detailed for {{ date_match.group(1) if date_match else source }}</summary>
            <table>
                <tr>
                    {% for key in details[0].keys() %}
                        <th>{{ key }}</th>
                    {% endfor %}
                </tr>
                {% for row in details %}
                <tr>
                    {% for value in row.values() %}
                        <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </details>
    {% endfor %}
</body>
</html>